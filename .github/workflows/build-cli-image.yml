# æž„å»º bootcs-cli å­¦å‘˜å¼€å‘çŽ¯å¢ƒé•œåƒ
#
# é»„é‡‘é•œåƒï¼šåŒ…å«æ‰€æœ‰æ”¯æŒçš„è¯­è¨€ (C, Python, Java)
# å­¦å‘˜åªéœ€ä½¿ç”¨ä¸€ä¸ªé•œåƒï¼Œæ— éœ€é€‰æ‹©
#
# é•œåƒæ ‡ç­¾:
#   - ghcr.io/bootcs-cn/bootcs-cli:latest (æŽ¨è)
#   - ghcr.io/bootcs-cn/bootcs-cli:v2.0.0 (ç‰ˆæœ¬å·)

name: Build CLI Image

on:
    workflow_dispatch:
        inputs:
            push:
                description: "Push image to registry"
                required: false
                default: true
                type: boolean

    push:
        branches: [main]
        paths:
            - "docker/**"
            - "pyproject.toml"
            - ".github/workflows/build-cli-image.yml"

    release:
        types: [published]

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: bootcs-cn/bootcs-cli

jobs:
    build:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Log in to Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Set up QEMU
              uses: docker/setup-qemu-action@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Extract version from pyproject.toml
              id: version
              run: |
                  VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "ðŸ“¦ Version: $VERSION"

            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
                  tags: |
                      # latest æ ‡ç­¾
                      type=raw,value=latest,enable={{is_default_branch}}
                      # ç‰ˆæœ¬æ ‡ç­¾ (ä»Ž pyproject.toml)
                      type=raw,value=v${{ steps.version.outputs.version }}
                      # Git SHA æ ‡ç­¾
                      type=sha,prefix=

            - name: Build and push image
              uses: docker/build-push-action@v5
              with:
                  context: ./docker
                  file: ./docker/Dockerfile
                  platforms: linux/amd64,linux/arm64
                  push: ${{ github.event_name != 'pull_request' && (inputs.push == true || inputs.push == null) }}
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Image summary
              run: |
                  echo "## ðŸ³ CLI Image Built" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Image:** \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Supported Languages:** C, Python, Java" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Quick Start" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
                  echo "# æœ¬åœ°è¯„æµ‹" >> $GITHUB_STEP_SUMMARY
                  echo "docker run --rm -v \$(pwd):/workspace ghcr.io/bootcs-cn/cli check cs50/hello" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "# æäº¤ä»£ç " >> $GITHUB_STEP_SUMMARY
                  echo "docker run --rm -v \$(pwd):/workspace ghcr.io/bootcs-cn/cli submit cs50/hello" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
